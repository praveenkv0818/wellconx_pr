{% extends 'base.html' %}
{% block content %}
<!-- Alpine.js for modal functionality -->
<script src="//unpkg.com/alpinejs" defer></script>

<div class="bg-white rounded-xl shadow-sm p-6" 
     x-data="{ open: false, visit: {} }">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-blue-600" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M8 7V3m8 4V3m-9 8h10m-11 8h12a2 2 0 002-2V7a2 2 0 00-2-2h-1V3m-10 0v2H6a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                Visit History &amp; Documentation
            </h2>
            <p class="text-gray-500 text-sm">
                Showing recent visit records of the latest patients
            </p>
        </div>
        <a href="{% url 'new_visit' %}" 
           class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 flex items-center gap-2">
            <span class="text-lg">+</span>
            <span>New Visit</span>
        </a>
    </div>

    {% if visits %}
        {% regroup visits by patient as patient_list %}
        {% for group in patient_list %}
            <div class="mb-8">
                <h3 class="font-semibold text-lg mb-2">
                    {{ group.grouper.name }} 
                    ({{ group.grouper.age }} yrs, {{ group.grouper.gender }})
                </h3>
                
                <div class="space-y-4">
                    {% for visit in group.list %}
                        <div class="border rounded-xl p-4 flex justify-between items-start hover:shadow-sm transition">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M8 7V3m8 4V3m-9 8h10m-11 8h12a2 2 0 002-2V7a2 2 0 00-2-2h-1V3m-10 0v2H6a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                    <span class="font-bold">{{ visit.date }}</span>
                                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-lg">
                                        {{ visit.healthcare_service }}
                                    </span>
                                </div>
                                <p class="text-gray-700">Doctor: {{ visit.doctor_name }}</p>
                                <p class="text-gray-500 text-sm">
                                    {{ visit.checkup_type }}{% if visit.notes %} - {{ visit.notes }}{% endif %}
                                </p>
                                <p class="text-gray-500 text-sm">
                                    BP: {{ visit.bp }} | Oâ‚‚: {{ visit.oxygen_level }} | Weight: {{ visit.weight }} kg
                                </p>
                            </div>
                            <!-- View Details triggers modal -->
                            <button 
                                @click="open = true; visit = {
                                    patient_name: '{{ group.grouper.name }}',
                                    age: '{{ group.grouper.age }}',
                                    gender: '{{ group.grouper.gender }}',
                                    date: '{{ visit.date }}',
                                    doctor_name: '{{ visit.doctor_name }}',
                                    checkup_type: '{{ visit.checkup_type }}',
                                    healthcare_service: '{{ visit.healthcare_service }}',
                                    bp: '{{ visit.bp }}',
                                    oxygen_level: '{{ visit.oxygen_level }}',
                                    weight: '{{ visit.weight }}',
                                    notes: '{{ visit.notes|default:'' }}'
                                }"
                                class="text-blue-600 hover:underline">
                                View Details
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-gray-500">No patient history found.</p>
    {% endif %}

    <!-- Modal with fade-in/fade-out -->
    <div 
        x-show="open"
        x-cloak
        @click.self="open = false"
        class="fixed inset-0 flex items-center justify-center z-50"
    >
        <!-- Background fade -->
        <div class="absolute inset-0 bg-black bg-opacity-50"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0">
        </div>

        <!-- Modal content fade -->
        <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg relative z-10"
             x-transition:enter="transition ease-out duration-200 transform"
             x-transition:enter-start="opacity-0 scale-95"
             x-transition:enter-end="opacity-100 scale-100"
             x-transition:leave="transition ease-in duration-200 transform"
             x-transition:leave-start="opacity-100 scale-100"
             x-transition:leave-end="opacity-0 scale-95">
            <h2 class="text-xl font-bold mb-4">Visit Details</h2>
            <p><strong>Patient:</strong> <span x-text="visit.patient_name"></span></p>
            <p><strong>Age:</strong> <span x-text="visit.age"></span> yrs</p>
            <p><strong>Gender:</strong> <span x-text="visit.gender"></span></p>
            <p><strong>Date:</strong> <span x-text="visit.date"></span></p>
            <p><strong>Doctor:</strong> <span x-text="visit.doctor_name"></span></p>
            <p><strong>Checkup Type:</strong> <span x-text="visit.checkup_type"></span></p>
            <p><strong>Service:</strong> <span x-text="visit.healthcare_service"></span></p>
            <p><strong>BP:</strong> <span x-text="visit.bp"></span></p>
            <p><strong>Oxygen Level:</strong> <span x-text="visit.oxygen_level"></span></p>
            <p><strong>Weight:</strong> <span x-text="visit.weight"></span> kg</p>
            <p><strong>Notes:</strong> <span x-text="visit.notes || 'No notes'"></span></p>
            <div class="mt-4 text-right">
                <button @click="open = false" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
